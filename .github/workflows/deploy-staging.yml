name: Deploy to Staging

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Docker image version tag to deploy (e.g., v0.3.4 or latest)'
        required: true
        default: 'latest'
        type: string
      reinstall:
        description: 'Force reinstall (clears all canister state). Use only when state is corrupted.'
        required: false
        default: false
        type: boolean

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: main
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Deploy to staging
        env:
          IC_IDENTITY_PEM: ${{ secrets.IC_IDENTITY_PEM }}
        run: |
          set -o pipefail
          mkdir -p deploy-staging-logs
          
          # Setup identity from secret
          mkdir -p ~/.config/dfx/identity/ci
          echo "$IC_IDENTITY_PEM" > ~/.config/dfx/identity/ci/identity.pem
          chmod 600 ~/.config/dfx/identity/ci/identity.pem
          
          echo "Deploying version: ${{ github.event.inputs.version }}"
          echo "Reinstall mode: ${{ github.event.inputs.reinstall }}"
          
          REINSTALL_ARG=""
          if [ "${{ github.event.inputs.reinstall }}" = "true" ]; then
            REINSTALL_ARG="--reinstall"
          fi
          
          docker run --rm \
            -e DFX_WARNING=-mainnet_plaintext_identity \
            -v "$(pwd)/deploy-staging-logs:/app/deploy-staging-logs" \
            -v "$HOME/.config/dfx:/root/.config/dfx" \
            ghcr.io/${{ github.repository_owner }}/kybra-simple-token:${{ github.event.inputs.version }} bash -c "
          dfxvm default 0.29.0 && \
          dfx identity use ci && \
          ./scripts/deploy_staging.sh $REINSTALL_ARG 2>&1; \
          EXIT_CODE=\$?; \
          cp -f token/dfx.log /app/deploy-staging-logs/ 2>/dev/null || true; \
          exit \$EXIT_CODE" 2>&1 | tee deploy-staging-logs/deploy-staging.log
      
      - name: Upload staging deploy logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-staging-logs
          path: deploy-staging-logs/
          retention-days: 7
