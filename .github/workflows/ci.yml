name: CI - Build & Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  ICP_DEV_IMAGE: ghcr.io/smart-social-contracts/icp-dev-env:db60540

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run CI (lint, unit tests, integration tests)
        run: |
          docker run --rm \
            -v "$(pwd):/workspace" \
            -w /workspace \
            ${{ env.ICP_DEV_IMAGE }} bash -c "
          set -e
          echo '=== Linting ==='
          pip install -q flake8 black isort
          ./token/scripts/run_linters.sh
          
          echo '=== Unit Tests (Token) ==='
          cd token && python tests/backend/test_token.py && cd ..
          
          echo '=== Unit Tests (NFT) ==='
          cd nft && python tests/backend/test_nft.py && cd ..
          
          echo '=== Integration Tests (Token) ==='
          ./token/scripts/run_integration_tests.sh
          
          echo '=== Integration Tests (NFT) ==='
          cd nft && ./tests/integration/entrypoint.sh && cd ..
          
          echo '=== All CI checks passed! ==='"
