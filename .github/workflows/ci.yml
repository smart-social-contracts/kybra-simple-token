name: CI - Build & Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push base image
        uses: docker/build-push-action@v4
        with:
          context: ./token
          target: base
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/kybra-simple-token:${{ github.sha }}
          no-cache: true
          pull: true

      - name: Build and push test image
        uses: docker/build-push-action@v4
        with:
          context: ./token
          target: test
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/kybra-simple-token:test-${{ github.sha }}
          pull: true
      
      - name: Verify Docker images
        if: always()
        run: |
          mkdir -p build-logs
          if docker image inspect ghcr.io/${{ github.repository_owner }}/kybra-simple-token:${{ github.sha }} >/dev/null 2>&1; then
            echo "✅ Base Docker image built successfully"
          else
            echo "❌ Base Docker image build failed"
            echo "Base Docker build failed" > build-logs/build-failed.txt
          fi
      
      - name: Save build metadata
        if: always()
        run: |
          echo "Commit: ${{ github.sha }}" > build-logs/build-info.txt
          echo "Image: ghcr.io/${{ github.repository_owner }}/kybra-simple-token:${{ github.sha }}" >> build-logs/build-info.txt
          echo "Branch: ${{ github.ref_name }}" >> build-logs/build-info.txt
          echo "Timestamp: $(date -u)" >> build-logs/build-info.txt
      
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build-logs/
          retention-days: 7

  test-backend:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run backend tests
        run: |
          mkdir -p test-logs
          docker run --rm \
            -v "$(pwd)/test-logs:/app/test-logs" \
            ghcr.io/${{ github.repository_owner }}/kybra-simple-token:test-${{ github.sha }} \
            ./scripts/run_tests.sh 2>&1 | tee test-logs/backend-tests.log
      
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-logs
          path: test-logs/
          retention-days: 7

  linting:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install linting tools
        run: pip install flake8 black isort
      
      - name: Run linters
        run: |
          mkdir -p lint-logs
          ./token/scripts/run_linters.sh 2>&1 | tee lint-logs/linters.log
      
      - name: Upload lint logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-logs
          path: lint-logs/
          retention-days: 7

  deploy-test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Test canister deployment
        run: |
          mkdir -p deploy-logs
          docker run --rm \
            -v "$(pwd)/deploy-logs:/app/deploy-logs" \
            ghcr.io/${{ github.repository_owner }}/kybra-simple-token:test-${{ github.sha }} bash -c "
          ./scripts/deploy_local.sh --clean 2>&1; \
          EXIT_CODE=\$?; \
          cp -f token/dfx.log /app/deploy-logs/ 2>/dev/null || true; \
          exit \$EXIT_CODE" 2>&1 | tee deploy-logs/deploy-test.log
      
      - name: Upload deploy logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-test-logs
          path: deploy-logs/
          retention-days: 7

  build-artifacts:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Build canister and extract artifacts
        run: |
          mkdir -p artifacts
          docker run --rm \
            -v "$(pwd)/artifacts:/app/artifacts" \
            ghcr.io/${{ github.repository_owner }}/kybra-simple-token:test-${{ github.sha }} bash -c "
          ./scripts/build_canister.sh /app/artifacts && \
          echo 'Build SHA: ${{ github.sha }}' >> /app/artifacts/BUILD_INFO.txt"
      
      - name: Upload backend wasm
        uses: actions/upload-artifact@v4
        with:
          name: token_backend.wasm
          path: artifacts/token_backend.wasm
          retention-days: 90
      
      - name: Upload backend did
        uses: actions/upload-artifact@v4
        with:
          name: token_backend.did
          path: artifacts/token_backend.did
          retention-days: 90
      
      - name: Upload frontend wasm
        uses: actions/upload-artifact@v4
        with:
          name: token_frontend.wasm
          path: artifacts/token_frontend.wasm
          retention-days: 90
      
      - name: Upload frontend did
        uses: actions/upload-artifact@v4
        with:
          name: token_frontend.did
          path: artifacts/token_frontend.did
          retention-days: 90
      
      - name: Upload all artifacts bundle
        uses: actions/upload-artifact@v4
        with:
          name: token-canister-artifacts
          path: artifacts/
          retention-days: 90

  deploy-staging:
    runs-on: ubuntu-latest
    needs: [build, test-backend, linting]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to staging
        env:
          DFX_IDENTITY_PEM: ${{ secrets.DFX_IDENTITY_PEM }}
        run: |
          mkdir -p deploy-staging-logs
          
          # Setup identity from secret
          mkdir -p ~/.config/dfx/identity/ci
          echo "$DFX_IDENTITY_PEM" > ~/.config/dfx/identity/ci/identity.pem
          chmod 600 ~/.config/dfx/identity/ci/identity.pem
          
          docker run --rm \
            -v "$(pwd)/deploy-staging-logs:/app/deploy-staging-logs" \
            -v "$HOME/.config/dfx:/root/.config/dfx" \
            ghcr.io/${{ github.repository_owner }}/kybra-simple-token:test-${{ github.sha }} bash -c "
          dfx identity use ci && \
          ./scripts/deploy_staging.sh 2>&1; \
          EXIT_CODE=\$?; \
          cp -f token/dfx.log /app/deploy-staging-logs/ 2>/dev/null || true; \
          exit \$EXIT_CODE" 2>&1 | tee deploy-staging-logs/deploy-staging.log
      
      - name: Upload staging deploy logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-staging-logs
          path: deploy-staging-logs/
          retention-days: 7
